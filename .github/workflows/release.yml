name: Release

on:
  workflow_dispatch:
    inputs:
      version:
        description: "Release version (e.g., 1.0.0)"
        required: true
        default: "1.0.0"
      draft:
        description: "Create as draft release?"
        required: false
        default: false
        type: boolean
      prerelease:
        description: "Mark as pre-release?"
        required: false
        default: false
        type: boolean

permissions:
  contents: write

env:
  VERSION: ${{ inputs.version }}
  BINARY_NAME: b4

jobs:
  test:
    name: Run Tests
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version-file: src/go.mod
          cache-dependency-path: src/go.sum

      - name: Run tests
        run: |
          cd src
          go test -v ./...

      - name: Run vet
        run: |
          cd src
          go vet ./...

  build-linux:
    name: Build Linux ${{ matrix.arch }}
    needs: test
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          # Primary architectures
          - { arch: amd64 }
          - { arch: arm64 }
          - { arch: 386 }

          # ARM variants
          - { arch: armv7 }
          - { arch: armv6 }
          - { arch: armv5 }

          # Other architectures
          - { arch: riscv64 }
          - { arch: ppc64le }
          - { arch: s390x }
          - { arch: mips }
          - { arch: mipsle }
          - { arch: mips64 }
          - { arch: mips64le }
          - { arch: ppc64 }
          - { arch: loong64 }

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version-file: src/go.mod
          cache-dependency-path: src/go.sum

      - name: Build using Makefile
        run: |
          make linux-${{ matrix.arch }} VERSION=${{ env.VERSION }}

      - name: Prepare artifacts
        run: |
          mkdir -p artifacts
          cp out/assets/* artifacts/

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.BINARY_NAME }}-linux-${{ matrix.arch }}
          path: artifacts/*
          retention-days: 1

  release:
    name: Create Release
    needs: [build-linux]
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: ${{ env.BINARY_NAME }}-*
          path: release-assets
          merge-multiple: true

      - name: Generate release files
        working-directory: release-assets
        run: |
          # Combine all individual checksums
          echo "=== SHA256 Checksums ===" > checksums.txt
          cat *.sha256 >> checksums.txt
          echo "" >> checksums.txt

          # Generate combined checksum files
          sha256sum *.tar.gz > SHA256SUMS

          # Create file list
          echo "Release contents:" > file-list.txt
          ls -lh *.tar.gz >> file-list.txt

          # Display what we're releasing
          echo "ðŸ“¦ Release artifacts:"
          ls -la

      - name: Read Changelog (Latest Version Only)
        id: read_changelog
        run: |
          echo "Extracting latest changelog entry..."
          CHANGELOG=$(awk '/^## \[/{if (found++) exit} found {print}' changelog.md)
          echo "changelog<<EOF" >> $GITHUB_OUTPUT
          echo "$CHANGELOG" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ env.VERSION }}
          name: B4 v${{ env.VERSION }}
          draft: ${{ inputs.draft }}
          prerelease: ${{ inputs.prerelease }}
          body: ${{ steps.read_changelog.outputs.changelog }}
          files: |
            release-assets/*.tar.gz
            release-assets/SHA256SUMS
            release-assets/checksums.txt
          generate_release_notes: true

  cleanup:
    name: Cleanup old artifacts
    needs: release
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Delete artifacts
        uses: geekyeggo/delete-artifact@v5
        with:
          name: ${{ env.BINARY_NAME }}-*
          failOnError: false
